#! /bin/bash -eu
#-*-sh-*-

# Run tests for kernel $1 defined in the environment's "tests" subdirectory

kernel=$1
kernel_test_dir="/opt/environments/${kernel}/tests"

echo "========================= Testing Environment ${kernel} =========================="
if [[ -d ${kernel_test_dir} ]]; then

    cd ${kernel_test_dir}

    source /opt/common-scripts/env-activate ${kernel}

    # Import every Python package listed in *imports files,  one per line
    # These can be comprehensive or parallel specific install files
    for import_list in `find ${kernel_test_dir} -name '*imports'`;
    do
        /opt/common-scripts/test-imports `cat ${import_list}`
    done
    
    # Run every notebook path listed in *notebooks files,  one per line
    # These can be comprehensive or parallel specific install files
    for notebook_list in `find ${kernel_test_dir} -name '*notebooks'`;
    do
        /opt/common-scripts/test-notebooks $kernel `cat ${notebook_list}`
    done

    # Run every notebook (*.ipynb) in the environment tests directory
    /opt/common-scripts/test-notebooks  $kernel  `find ${kernel_test_dir} -name '*.ipynb'`

    source /opt/common-scripts/env-deactivate ${kernel}

else
    echo "Skipping kernel ${kernel} with no 'tests' directory."
fi
